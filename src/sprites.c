#include <cmsis_os.h>
#include <lpc17xx.h>
#include <stdbool.h>
#include <stdio.h>
#include <string.h>
#include "GLCD.h"
#include "graphics.h"
#include "sprites.h"
#include "math.h"
#include "helper.h"

 const uint16_t tankmap1[] = {
  0xffff, 0xffde, 0xffff, 0xf79e, 0xffff, 0xffdf, 0xffff, 0x0000, 0x0000, 0x0041, 0x0000, 0x0021, 0x0021, 0x0000, 0x0020, 0x0000, 
	0x0000, 0x0861, 0x0000, 0x0000, 0x0021, 0x0000, 0x0001, 0x0000, 0x0001, 0x0020, 0xf79d, 0xffff, 0xffff, 0xffff, 0xffff, 0xf79e, 
	0xffff, 0xf7be, 0xffff, 0xffff, 0xef3c, 0x0820, 0x18c3, 0x4a28, 0x4a49, 0x4208, 0x0800, 0x0841, 0x41e7, 0x1062, 0x0000, 0x4a48, 
	0x4a28, 0x4207, 0x0820, 0x1061, 0x41e7, 0x1062, 0x0000, 0x4a49, 0x41c7, 0x0800, 0x20c2, 0xd679, 0xffff, 0xf79e, 0xe71c, 0xffff, 
	0xdf3d, 0xffff, 0xd69b, 0x20c3, 0x2082, 0x0800, 0x4186, 0x5a49, 0x5208, 0x1000, 0x1000, 0x4165, 0x628a, 0x49e7, 0x1841, 0x0800, 
	0x5208, 0x1000, 0x1000, 0x4186, 0x62aa, 0x49e7, 0x1041, 0x0800, 0x5a48, 0x5a28, 0x1000, 0x5a08, 0xc575, 0xffff, 0xffff, 0xef7e, 
	0xffff, 0xce59, 0x49e8, 0x1000, 0x1800, 0x3041, 0x3861, 0x2800, 0x3000, 0x2800, 0x3800, 0x3800, 0x2800, 0x2800, 0x2800, 0x2800, 
	0x3000, 0x2000, 0x3000, 0x3000, 0x2000, 0x2800, 0x2800, 0x2800, 0x2800, 0x4061, 0x3800, 0x4882, 0x61a7, 0xe639, 0xef1c, 0xffff, 
	0xf6fb, 0x30a2, 0x1800, 0x71c7, 0x926a, 0x7104, 0x70c3, 0x8986, 0x8944, 0x9165, 0x9104, 0x9125, 0xa166, 0x9145, 0x8925, 0x8925, 
	0x8945, 0x9166, 0x8925, 0x9125, 0x9966, 0x9145, 0x9145, 0x8944, 0x9145, 0x78a2, 0xa1c7, 0x9186, 0x6904, 0x3841, 0x30c2, 0xff5c, 
	0x2061, 0x1800, 0x5124, 0x7a08, 0x5882, 0x68c3, 0x89a6, 0x8144, 0x9165, 0x8924, 0x9104, 0xa145, 0x98c4, 0x98a3, 0xa945, 0x9904, 
	0x98e4, 0x98e3, 0x98e4, 0xa145, 0x98e4, 0x90e3, 0x9965, 0x9165, 0xa1a6, 0x8904, 0x8904, 0x8945, 0x89e8, 0x5945, 0x1000, 0x1020, 
	0x0000, 0x18a2, 0x0800, 0x30a3, 0x1800, 0x1800, 0x2800, 0x2800, 0x2800, 0x4000, 0x5000, 0x5000, 0x6800, 0x6800, 0x6800, 0x7000, 
	0x6800, 0x7000, 0x6800, 0x5800, 0x6020, 0x5040, 0x3000, 0x2800, 0x2000, 0x3861, 0x2800, 0x3841, 0x1800, 0x2862, 0x0000, 0x0000, 
	0xffff, 0xef9e, 0x1061, 0x0000, 0x1021, 0x0800, 0x1020, 0x0800, 0x1000, 0x2800, 0x6965, 0x8986, 0x9124, 0xa124, 0x98c3, 0xa103, 
	0xa104, 0x98c3, 0xa145, 0x8924, 0x8186, 0x6165, 0x2000, 0x1000, 0x1841, 0xf73c, 0xffdf, 0xff3c, 0x2082, 0x0000, 0x0020, 0xffff, 
	0xffff, 0xffff, 0x0000, 0xffff, 0xffff, 0xffff, 0xffbe, 0x0840, 0x1020, 0x1800, 0x4000, 0x9186, 0x98a3, 0xb0e4, 0xb882, 0xc0a3, 
	0xb882, 0xb8c4, 0xa8e4, 0x9945, 0x8125, 0x3000, 0x2020, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 
	0xffff, 0xffff, 0x0820, 0xffff, 0xffff, 0xffff, 0xffff, 0xef7d, 0xef3c, 0x4985, 0x2000, 0x7924, 0xa9a7, 0xa904, 0xa041, 0xc0e4, 
	0xb0a3, 0xb105, 0x98c3, 0x8924, 0x3000, 0x38a2, 0xf71c, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 
	0xffff, 0xffff, 0x0000, 0xffff, 0xffff, 0xffff, 0xefdf, 0xf7ff, 0xffff, 0xc5f7, 0x4145, 0x2000, 0x3000, 0x7924, 0xa248, 0x8103, 
	0x8986, 0x8165, 0x3800, 0x5103, 0xff3c, 0xffff, 0xef3d, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 
	0xffff, 0xf7be, 0x2124, 0xef5d, 0xffff, 0xffff, 0xffff, 0xf7ff, 0xe77d, 0xffff, 0xffff, 0xde59, 0x5186, 0x1800, 0x2800, 0x3000, 
	0x2000, 0x3882, 0xf6ba, 0xffde, 0xf79d, 0xffff, 0xffff, 0xf7df, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 
	0xffff, 0xffff, 0xe73c, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xce38, 0x3104, 0x0800, 0x1000, 
	0x2061, 0xff5c, 0xffff, 0xffff, 0xffff, 0xf7ff, 0xef9e, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 
};
 
const uint16_t tankmap2[] = {
	0xffdf, 0xffff, 0xf7be, 0xffff, 0xf7be, 0xffff, 0xefbf, 0x0042, 0x0063, 0x0023, 0x0065, 0x0065, 0x0045, 0x0024, 0x00e7, 0x0024, 
	0x0064, 0x0024, 0x0024, 0x0065, 0x0045, 0x0045, 0x0065, 0x0064, 0x0001, 0xffff, 0xffff, 0xffff, 0xffdf, 0xffff, 0xffff, 0xfffe, 
	0xffff, 0xffff, 0xffff, 0xf7be, 0xffff, 0xefbf, 0x0063, 0x0064, 0x63b1, 0x0907, 0x5bd3, 0x6c35, 0x6415, 0x00e8, 0x53b3, 0x6c75, 
	0x63f3, 0x0086, 0x6c34, 0x63f4, 0x6c35, 0x0066, 0x63f4, 0x63f3, 0x0063, 0x0042, 0x0000, 0xdedb, 0xffff, 0xf7df, 0xe73c, 0xffff, 
	0xffff, 0xf79e, 0xffff, 0xf7bf, 0x0884, 0x0002, 0x0065, 0x63f3, 0x0929, 0x4352, 0x012a, 0x4b94, 0x010a, 0x4393, 0x012a, 0x53f4, 
	0x0109, 0x4bd4, 0x012a, 0x4373, 0x012b, 0x53d5, 0x014b, 0x5bf5, 0x0004, 0x0064, 0x0043, 0x29c8, 0xb5b8, 0xffff, 0xffff, 0xef5c, 
	0xffff, 0xffff, 0x0000, 0x0001, 0x0044, 0x73f4, 0x6c15, 0x0087, 0x5394, 0x6c98, 0x5c16, 0x012a, 0x5c36, 0x6c76, 0x5bd3, 0x00c6, 
	0x5c34, 0x64b6, 0x4bb3, 0x014a, 0x4374, 0x6c98, 0x4b94, 0x00c9, 0x6c35, 0x7455, 0x5b51, 0x0003, 0x2167, 0xd6fc, 0xffff, 0xffff, 
	0xfffe, 0xef9d, 0x08a3, 0x00a4, 0x0003, 0x0086, 0x0066, 0x0087, 0x0087, 0x00c8, 0x0026, 0x0087, 0x0024, 0x0023, 0x08e5, 0x0020, 
	0x00a2, 0x0041, 0x0083, 0x0023, 0x00e7, 0x0086, 0x0067, 0x0067, 0x0087, 0x0045, 0x1169, 0x0044, 0x0023, 0x08c5, 0x1905, 0xdf3d, 
	0xffff, 0x0020, 0x0000, 0x7411, 0x7413, 0x7434, 0x6bf4, 0x63f4, 0x6c35, 0x5bf4, 0x6c77, 0x5bf4, 0x6413, 0x0106, 0x7c73, 0xa5b6, 
	0x8d13, 0xa5f7, 0x8515, 0x00c5, 0x5bd3, 0x5bf4, 0x6c76, 0x6415, 0x6c56, 0x63d3, 0x5391, 0x7475, 0x6c33, 0x6bd1, 0x0001, 0x10e3, 
	0x0000, 0x0000, 0x1083, 0x0001, 0x08a5, 0x0002, 0x0044, 0x0065, 0x0045, 0x00a7, 0x00a8, 0x00a8, 0x0109, 0x0045, 0x0148, 0x0064, 
	0x00e5, 0x0043, 0x0085, 0x00c8, 0x0067, 0x00e9, 0x0088, 0x0086, 0x0004, 0x1107, 0x0002, 0x10e6, 0x0002, 0x29a7, 0x0000, 0x0000, 
	0x0000, 0x0841, 0x0000, 0x0042, 0xef7e, 0xffff, 0xf7bf, 0x0022, 0x0044, 0x6c14, 0x5c15, 0x5c78, 0x4417, 0x5499, 0x4436, 0x4c97, 
	0x4c76, 0x4c77, 0x4c58, 0x4c58, 0x4c38, 0x6499, 0x53d4, 0x6c34, 0x0085, 0xe77f, 0xffff, 0xe75e, 0x2146, 0xd6bb, 0xffff, 0xffff, 
	0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0x0022, 0x0024, 0x5c36, 0x651b, 0x2bf9, 0x3cdd, 0x2cbc, 0x24bc, 
	0x2cbd, 0x2c9c, 0x2c9d, 0x3cbd, 0x343a, 0x4c79, 0x6477, 0x0024, 0x08c5, 0xe71d, 0xffff, 0xf7be, 0x0020, 0xffff, 0xffff, 0xffff, 
	0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xe75d, 0x1968, 0x0045, 0x2b54, 0x553e, 0x245b, 0x2cfe, 0x24fe, 
	0x1cde, 0x24df, 0x1c3c, 0x243b, 0x659f, 0x3bd6, 0x0045, 0x00a5, 0xe75e, 0xffff, 0xffff, 0xffbe, 0x0020, 0xffff, 0xffff, 0xffff, 
	0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xb618, 0x19c9, 0x0066, 0x54b9, 0x3c7a, 0x34bb, 0x245a, 
	0x2cbb, 0x2c9b, 0x3cdc, 0x551c, 0x2b53, 0x0066, 0x0927, 0xef9f, 0xffff, 0xffff, 0xf7be, 0xffff, 0x0841, 0xffff, 0xffff, 0xffff, 
	0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xf79d, 0xffff, 0xdf5e, 0x00e6, 0x4bd4, 0x5478, 0x4458, 0x4cda, 
	0x4479, 0x4478, 0x4437, 0x4c16, 0x0066, 0x19a9, 0xc65a, 0xffff, 0xffdf, 0xf7be, 0xffff, 0xffff, 0x0000, 0xf7df, 0xffff, 0xffff, 
	0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0x0063, 0x0003, 0x0065, 0x0066, 0x0066, 
	0x0046, 0x00a7, 0x0025, 0x0086, 0x0023, 0xd69b, 0xffff, 0xffbe, 0xffff, 0xffff, 0xffff, 0xffff, 0x0000, 0xffff, 0xffff, 0xfffe, 
};
 
uint16_t barrelmap[TANK_WIDTH*TANK_WIDTH];

void printBarrelmap(void) {
	for (int idx = 0; idx < TANK_WIDTH * TANK_WIDTH; idx++) {
		printf("%x ", barrelmap[idx]);
		if (!(idx % TANK_WIDTH)) printf("\n");
	}
}

void initBarrelmap(char player) {
	loadBarrelmap(player == 1 ? 0 : 180);
}

void loadBarrelmap(int a) {
	// Generate a sprite map that is tank_width^2 size with a line of pixels with the angle specified, from the middle
	
	double angle = toRad(a);
	int idx;
	
	int startx = TANK_WIDTH / 2;
	int starty = TANK_HEIGHT;
	
	int x, y, h2;
	double cursin, curcos;
  double sinang = sin(angle);
	double cosang = cos(angle);
	double tol = 0.1;
	
	for (idx = 0; idx < TANK_WIDTH * TANK_WIDTH; idx++) {
		x = idx % TANK_WIDTH - startx;
		y = idx / TANK_WIDTH - starty;
		h2 = x*x+y*y;
		cursin = y*fastInvsqrt(h2);
		curcos = x*fastInvsqrt(h2);
		//printf("x: %d y: %d h2: %f cursin: %f curcos: %f \n", x, y, h2, cursin, curcos);
		if (h2 <= BARREL_LENGTH2 && 
			  cursin <= sinang + tol && cursin >= sinang - tol &&
		    curcos <= cosang + tol && curcos >= cosang - tol) {
			barrelmap[idx] = BARREL_COLOR;
		} else {
			barrelmap[idx] = BACKGROUND_COLOR;
		}
	}
}

const uint16_t shotmap[] = {
	0x50E3, 0x50E3, 0x50E3, 0x50E3,
	0x50E3, 0x50E3, 0x50E3, 0x50E3,
	0x50E3, 0x50E3, 0x50E3, 0x50E3,
	0x50E3, 0x50E3, 0x50E3, 0x50E3,
};

const uint16_t terrainFull[] = {
	0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000,
};

const uint16_t terrainLSlope[] = {
	0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0xffff,
	0x0000, 0x0000, 0xffff, 0xffff,
	0x0000, 0xffff, 0xffff, 0xffff,
};

const uint16_t terrainRSlope[] = {
	0x0000, 0x0000, 0x0000, 0x0000,
	0xffff, 0x0000, 0x0000, 0x0000,
	0xffff, 0xffff, 0x0000, 0x0000,
	0xffff, 0xffff, 0xffff, 0x0000,
};

const uint16_t explode1map[] = {
	0xEC82, 0xE123, 0xEC82, 0xEC82,
	0xEC82, 0xEC82, 0xEC82, 0xE123,
	0xE123, 0xEC82, 0xE123, 0xEC82,
	0xE123, 0xEC82, 0xEC82, 0xE123
};

const uint16_t explode2map[] = {
	0xE123, 0xEC82, 0xE123, 0xEC82,
	0xEC82, 0xE123, 0xEC82, 0xEC82,
	0xEC82, 0xEC82, 0xE123, 0xEC82,
	0xE123, 0xEC82, 0xE123, 0xEC82
};



